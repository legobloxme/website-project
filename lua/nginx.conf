worker_processes auto;
error_log logs/error.log;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;
    
    lua_package_path "/opt/openresty/nginx/lua/?.lua;;";
    
    server {
        listen 80;
        server_name _;
        
        root /opt/openresty/nginx/html;
        index index.html;
        
        # Serve static FNAF page at root
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # JSON API endpoint
        location /api {
            content_by_lua_block {
                local app = require "app"
                app.api()
            }
        }
        
        # Dynamic time endpoint
        location /time {
            content_by_lua_block {
                local app = require "app"
                app.time()
            }
        }
        
        # Echo request data
        location /echo {
            content_by_lua_block {
                local app = require "app"
                app.echo()
            }
        }
        
        # Animatronic status API
        location /api/animatronics {
            content_by_lua_block {
                local app = require "app"
                app.animatronics()
            }
        }
        
        # Power status API
        location /api/power {
            content_by_lua_block {
                local app = require "app"
                app.power()
            }
        }
        
        # ============================================
        # DOOR CONTROL ENDPOINTS (New!)
        # ============================================
        
        # Toggle a door (open/close)
        # Usage: /api/door?side=left or /api/door?side=right
        location /api/door {
            content_by_lua_block {
                local app = require "app"
                app.toggle_door()
            }
        }
        
        # Get status of both doors
        location /api/doors {
            content_by_lua_block {
                local app = require "app"
                app.get_doors()
            }
        }
        
        # Reset the game (power back to 100%)
        location /api/reset {
            content_by_lua_block {
                local app = require "app"
                app.reset()
            }
        }
    }
}
